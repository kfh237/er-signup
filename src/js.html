<!-- NOTES -->
<!--
  - error handler for netid not found
    - if netid not found, show new student intake form
-->

<script>
  let step = 0;
  let delay = 2000;
  let student;

  const sections = [
    'StudentInfo',
    'Agree',
    'Confirmation'
  ];

  const main = document.getElementsByTagName('main')[0];
  const sectionContent = document.getElementById('section-content');
  const controls = document.getElementById('controls');

  const renderContent = (content) => {
    sectionContent.innerHTML = content;
  };

  const studentInfo = (_student) => {
    student = _student;
    console.log(student);

    let inputs = document.querySelectorAll('#student-info input');
    let classOptions = document.querySelectorAll('#class option');
    let buttons = document.querySelectorAll('#student-info button');

    if (!!student) {
      inputs.forEach((input, i) => {
        input.defaultValue = student[i];
        input.value = student[i];
      });

      classOptions.forEach((option) => {
        if (option.value == student[7]) option.setAttribute('selected', '');
      });

      buttons.forEach((button, i) => {
        button.addEventListener('click', updateStudent);
      });
    } else {
      student = new Array(8);
      // leave the form empty
      // remove the 'make changes' button
      // bind a createStudent function to remaining button click event
    }

    main.classList.remove('loading');
  };

  const createStudent = (event) => {
    event.preventDefault();
  }

  const updateStudent = (event) => {
    event.preventDefault();

    let inputs = document.querySelectorAll('#student-info input');
    let changed = false;

    if (event.target.id == 'update-info') {
      inputs.forEach((input) => {
        input.removeAttribute('disabled');
      });

      document.querySelector('#class').removeAttribute('disabled');

      event.target.setAttribute('disabled', '');
    } else {
      main.classList.add('loading');
      let data = [];

      inputs.forEach((input, i) => {
        if (input.value != input.defaultValue) {
          data[i] = input.value;
          changed = true;
        }
      });

      if (changed) {
        google.script.run.withSuccessHandler(proceed).updateStudent(data);
      } else {
        proceed();
      }
    }
  }

  const showConfirmation = (data) => {
    console.log(data);
    main.classList.remove('loading');
  }

  const proceed = (event) => {
    if (!!event) event.preventDefault();

    let netid;
    if (step == 0) {
      netid = document.querySelector('#netid').value;
    }

    if (step == 2 && !document.getElementById('agree').checked) {
      alert('You must check the box to proceed');
      return;
    }

    main.classList.add('loading');

    let section = sections[step];

    google.script.run.withSuccessHandler((content) => {
      renderContent(content);

      switch(step) {
        case 0:
          document.querySelectorAll('.field-0, #next').forEach((el) => {
            el.classList.add('hidden');
          });
          google.script.run.withSuccessHandler(studentInfo).lookupStudent(netid);
          break;
        case 1:
          document.querySelector('#next').classList.remove('hidden');
          main.classList.remove('loading');
          break;
        case 2:
          document.querySelector('#next').classList.add('hidden');
          google.script.run.withSuccessHandler(showConfirmation).submitAgreement();
          break;
        default:
          main.classList.remove('loading');
          break;
      }

      step++;
    }).include(section);
  };

  document.querySelector('#next').addEventListener('click', proceed);
</script>